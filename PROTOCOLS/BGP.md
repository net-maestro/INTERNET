## BGP Communities Best-Path Selection

---

### 1. Стандартные BGP Communities

#### 1.1. Стандартные Communities (RFC 1997)
| Community               | Описание |
|------------------------|----------|
| `no-export` (65535:65281)  | Не передавать маршрут за пределы AS |
| `no-advertise` (65535:65282)  | Не передавать маршрут никому |
| `local-AS` (65535:65283)  | Не передавать маршрут за пределы локального AS-партнёра |
| `internet` (65535:0)  | Разрешает анонс маршрута всем (дефолт) |

---

#### 1.2. Принятые соглашения у Tier-1/провайдеров
| Community       | Описание |
|----------------|----------|
| `X:666`       | Черная дыра (Blackhole) – дроп всего трафика |
| `X:100`       | Высокий приоритет маршрута |
| `X:200`       | Средний приоритет маршрута |
| `X:300`       | Низкий приоритет маршрута |
| `X:500`       | Фильтрация маршрута (не анонсировать) |

Где `X` – ASN провайдера.

---

#### 1.3. Приватные Communities (используются внутри ISP)
| Community       | Описание |
|----------------|----------|
| `AS:50`       | Добавляет +50 Local Preference |
| `AS:90`       | Добавляет +90 Local Preference |
| `AS:9999`     | Drop трафика на уровне провайдера |

---

### 2. Значения предпочтения маршрута BGP и их применение

| Параметр               | Описание | Применение |
|------------------------|----------|------------|
| `weight`              | Внутренний параметр (чем выше, тем предпочтительнее) | Локален для роутера, **не передается** между AS, применяется **первым** `in-filter` в Best-Path Selection |
| `local-pref`          | Local Preference (чем выше, тем предпочтительнее маршрут) | **Передается внутри AS**, но **не передается между AS**, используется для управления выходящими маршрутами `in-filter` |
| `as-path`             | Длина пути AS (чем короче, тем предпочтительнее) | Применяется автоматически, можно изменять в `in-filter`, влияет на выбор маршрута между разными AS |
| `origin`              | Показывает источник маршрута (`IGP`, `EGP`, `Incomplete`) | `IGP` предпочтительнее `EGP`, `EGP` предпочтительнее `Incomplete` |
| `med`                 | Multi-Exit Discriminator (чем ниже, тем предпочтительнее) | **Передается между AS**, но только если AS-путь совпадает, используется на **входящих маршрутах** (`in-filter`) и влияет на выбор маршрута у соседнего AS |
| `community`           | Дополнительные метки маршрута | Используется в `in-filter` и `out-filter` для маршрутизации и управления политиками |
| `next-hop`            | Адрес следующего узла маршрута | Должен быть достижим, иначе маршрут считается недействительным |
| `router-id`           | Идентификатор маршрутизатора, из которого получен маршрут | Если все параметры выше равны, выбирается маршрут от маршрутизатора с **меньшим** `router-id` |
| `tie-break (shortest cluster-list)` | Используется в iBGP, если маршруты равны | Выбирается маршрут с **меньшим** числом маршрутизаторов в Cluster List |

### 3. Дополнительные механизмы управления маршрутами BGP

| Параметр               | Описание | Применение |
|------------------------|----------|------------|
| `bgp-prepend`         | Искусственное удлинение AS-пути | Используется для снижения приоритета маршрута путем добавления дополнительных AS-номеров в `as-path` `out-filter`|
| `bgp-prepend-path`    | Управление путем BGP-препенда | Позволяет задавать конкретные AS для удлинения маршрута, управляя политиками выхода `out-filter`|
| `communities-set`     | Установка community-атрибутов | Применяется для маркировки маршрутов и управления их обработкой в `in-filter` и `out-filter` |
| `large-community`     | Расширенный вариант `community` | Позволяет задавать более сложные политики маршрутизации, передается между AS |
| `route-map`           | Гибкая политика фильтрации маршрутов | Используется для изменения параметров маршрутов на основе заданных условий |
| `peer-group`          | Группировка BGP-пиров | Позволяет упростить конфигурацию и применение политик для группы соседей BGP |

---


# BGP Local Role в MikroTik RouterOS

В RouterOS v7 BGP Local Role упрощает настройку фильтров и политик маршрутизации в зависимости от роли маршрутизатора в сети. 

## Таблица ролей BGP Local Role

| Роль                 | Тип BGP | Описание |
|----------------------|--------|----------|
| **ebgp**            | eBGP   | Обычный eBGP-пиринг между автономными системами (AS). Нет автоматических фильтров. |
| **ebgp customer**   | eBGP   | Используется, если MikroTik получает интернет-объявления от провайдера. Автоматически фильтрует private AS и устанавливает `default-originate if-installed`. |
| **ebgp peer**       | eBGP   | Обычный eBGP-пиринг между равными партнёрами (peering). Применяет стандартные фильтры, но не объявляет `0.0.0.0/0`. |
| **ebgp provider**   | eBGP   | Используется, если MikroTik предоставляет интернет клиенту. Разрешает анонсы от клиента, но запрещает transit. |
| **ebgp rs**         | eBGP   | Маршрутизатор Route Server (RS) на обменных точках (IX). Передаёт все маршруты без изменений, но не устанавливает next-hop. |
| **ebgp rs client**  | eBGP   | Клиент Route Server, получает полную таблицу BGP от RS. Отправляет свои маршруты на Route Server, но не передаёт чужие. |
| **ibgp**            | iBGP   | Обычный IBGP-сосед внутри автономной системы. Требует полносетевой связности (full mesh) или Route Reflector. |
| **ibgp rr**         | iBGP   | Route Reflector (RR), передаёт маршруты между IBGP-клиентами. Обходит ограничение IBGP о полном соединении (full mesh). |

## Примечания
- `ebgp customer` и `ebgp provider` автоматически применяют преднастроенные фильтры для управления маршрутами.
- `ebgp rs` и `ebgp rs client` удобны для работы с Internet Exchange (IX).
- `ibgp rr` нужен, если в сети **более двух IBGP-маршрутизаторов**, чтобы избежать full mesh-топологии.

## Команда для установки Local Role
```shell
/routing/bgp/connection/set role=<role_name>

