# Таблица конфигурации STP для Cisco Nexus

| Вариант                | Команда                          | Что делает                                                                 | Защита от петли / STP | Реакция на поддельный коммутационный трафик | Риски                                        | Рекомендации                                   |
|------------------------|----------------------------------|---------------------------------------------------------------------------|-----------------------|--------------------------------------------|---------------------------------------------|-----------------------------------------------|
| 1. Edge Trunk + Guard None | `spanning-tree port type edge trunk`<br>`spanning-tree guard none` | Порт сразу в forwarding, не блокирует при включении | Нет защиты            | Порт видит BPDU, но сразу обозначает<br>своим — возможны<br>вредоносные петли | Возможны петли из-за<br>отсутствия защиты | Используйте только на<br>конечных портах, где<br>нет риска поддельных BPDU. |
| 2. BPDU Filter Enable | `spanning-tree bpdufilter enable` | Порт полностью игнорирует BPDU, STP отключен | Нет защиты            | Порт не реагирует на<br>BPDU, состояние<br>предсказуемое | Потеря возможности<br>обнаружения петель | Используйте на портах<br>с клиентским трафиком,<br>где нет шансов на STP. |
| 3. BPDU Guard Enable  | `spanning-tree bpduguard enable` | Если порт получает BPDU — автоматический<br>shutdown / err-disable | Да, защита от<br>непредвиденных<br>коммутаторов            | Любой BPDU сразу<br>выключает порт       | Потеря порта при<br>случайном подключении<br>свича            | Идеально для edge-портов,<br>где должны быть<br>только хосты (серверы, IP-телефоны). |
| 4. Общий trunk c Loop Guard | `spanning-tree guard loop`<br>`enable` | STP работает как обычно,<br>Loop Guard<br>проверяет блокировку<br>портов               | Порт блокирует при<br>потере BPDU         | Минимум рисков при<br>подключении свича    | Минимизация<br>непредвиденных<br>петель            | Рекомендуется для trunk<br>между свичами,<br>особенно для VLAN с резервированием. |

## Дополнительные комментарии 

- **Edge Trunk + Guard None**: Этот вариант подходит для конечных устройств (например, серверов или IP-телефонов), но требует осторожности. Если есть риск подключения другого коммутатора, лучше добавить `bpduguard` для защиты от петель.
- **BPDU Filter**: Полезно на портах, где точно не будет другого коммутатора (например, клиентские точки доступа). Однако это отключает STP, что может привести к неконтролируемым ситуациям при ошибках конфигурации.
- **BPDU Guard**: Обязателен для всех edge-портов в средах Cisco Nexus, особенно в дата-центрах. Автоматический shutdown при обнаружении BPDU минимизирует риски. Не забывайте настроить `errdisable recovery` с интервалом (например, 90 секунд) для автоматического восстановления.
- **Loop Guard**: Критичен для trunk-линков между коммутаторами, особенно в топологиях с резервированием (например, с использованием vPC). Это предотвращает односторонние сбои, когда один конец линка теряет BPDU.

Для надежной работы рекомендуется комбинировать эти механизмы в зависимости от роли порта и топологии сети. Например, на агрегационных коммутаторах (N9K) часто используется `bpduguard` на access-портах и `loopguard` на uplink-трафике.
