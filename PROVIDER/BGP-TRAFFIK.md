# Влияние на трафик в BGP: Входящий vs. Исходящий

## Общие принципы BGP-маршрутизации
BGP (Border Gateway Protocol) — это протокол маршрутизации между автономными системами (AS), который основан на политике маршрутизации. В отличие от IGP (например, OSPF или IS-IS), BGP не использует метрики, такие как стоимость пути или задержка. Вместо этого он принимает решения на основе атрибутов маршрутов.

## Контроль исходящего трафика
На исходящий трафик можно эффективно влиять, так как мы сами выбираем, через какой маршрут отправлять пакеты в удаленные сети. Для этого используются:

1. **Local Preference (LPREF)**
   - Чем выше значение LPREF, тем предпочтительнее маршрут.
   - Используется внутри одной автономной системы (iBGP).
   - Изменяется через команду:
     ```
     route-map OUTGOING permit 10
     set local-preference 200
     ```

2. **AS Path Prepending**
   - Искусственное увеличение длины AS-пути, чтобы сделать маршрут менее привлекательным для других автономных систем.
   - Используется, если у нас несколько выходных маршрутов и мы хотим управлять их приоритетом.
   - Пример настройки:
     ```
     route-map PREPEND permit 10
     set as-path prepend 65000 65000 65000
     ```

3. **MED (Multi-Exit Discriminator)**
   - Показывает предпочтительный вход в AS для внешних соседей.
   - Работает только при договоренности между соседними AS.
   - Чем ниже MED, тем предпочтительнее маршрут.
   - Настраивается так:
     ```
     route-map MED_SET permit 10
     set metric 50
     ```

## Контроль входящего трафика
Влиять на входящий трафик сложнее, так как он определяется маршрутизацией удаленных систем. Однако есть несколько способов повлиять на него:

1. **AS Path Prepending (на своих анонсах)**
   - Используется для уменьшения привлекательности маршрута.
   - Например, если у нас есть два провайдера, можно удлинить AS-PATH для менее предпочтительного маршрута.

2. **MED (если поддерживается соседом)**
   - Некоторые провайдеры принимают MED в расчет, но это не гарантированное решение.

3. **Раздельная анонсация префиксов**
   - Можно анонсировать более специфичные сети через одного провайдера, а менее специфичные — через другого.
   - Например:
     ```
     network 192.168.1.0/24
     network 192.168.1.0/25
     ```

4. **Community (в зависимости от провайдера)**
   - Некоторые провайдеры поддерживают BGP communities, с помощью которых можно задавать предпочтения трафика.
   - Пример использования:
     ```
     route-map SET_COMM permit 10
     set community 65000:100
     ```

## Поведение трафика и фильтры внутри автономной системы (iBGP)
Внутри одной автономной системы (iBGP) маршруты распространяются без изменения AS_PATH, поэтому необходимо учитывать:

1. **Полносетевую (Full Mesh) топологию**
   - iBGP не передает маршруты от одного iBGP соседа другому (split-horizon rule), поэтому необходимо:
     - Использовать полносетевое соединение (full mesh),
     - Применять Route Reflectors (RR),
     - Использовать Confederations.

2. **Фильтрацию маршрутов внутри AS**
   - Используется для управления распространением маршрутов между iBGP-узлами.
   - Можно применять prefix-lists, route-maps и communities.
   - Пример:
     ```
     route-map FILTER_IBGP permit 10
     match ip address prefix-list INTERNAL_ROUTES
     ```

3. **Next-Hop Processing**
   - В iBGP next-hop значение маршрута не меняется, если он получен от eBGP-соседа.
   - Нужно использовать команду:
     ```
     neighbor X.X.X.X next-hop-self
     ```
   - Это особенно важно для маршрутов, передаваемых через Route Reflector.

## Вывод
- **Исходящий трафик** можно контролировать напрямую с помощью Local Preference, AS Path Prepending и MED.
- **Входящий трафик** можно частично контролировать с помощью AS Path Prepending, MED, раздельных анонсов и BGP communities.
- **Внутри AS (iBGP)** важно учитывать топологию full mesh, применение Route Reflectors и фильтрацию маршрутов для эффективного управления трафиком.
- Полный контроль входящего трафика невозможен, так как окончательное решение остается за удаленными системами.


### Про router-id
- **В eBGP router-id может быть недоступным в сети, так как next-hop изменяется на IP соседнего маршрутизатора.**
- **В iBGP router-id (если он используется в next-hop) должен быть доступен через IGP, иначе маршруты станут недоступными.**

